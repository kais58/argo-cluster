apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: kube-prometheus-stack
  namespace: argo-system
  finalizers: [resources-finalizer.argocd.argoproj.io]
spec:
  generators:
    - list:
        elements:
          - environment: mgmt
            cluster: in-cluster
  template:
    metadata:
      name: '{{ environment }}-kube-prometheus-stack'
      finalizers: [resources-finalizer.argocd.argoproj.io]
    spec:
      project: infra
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - ServerSideApply=true
      destination:
        name: '{{ cluster }}'
        namespace: monitoring
      source:
        - repoURL: "https://github.com/kais58/argo-cluster.git"
          path: kubernetes/apps/cert-manager/cert-manager
          targetRevision: main
          ref: repo
        - repoURL: https://prometheus-community.github.io/helm-charts
          chart: kube-prometheus-stack
          targetRevision: 78.3.2
          helm:
            values: |-
              prometheus:
                enabled: true
              grafana:
                enabled: true
                additionalDataSources:
                  - name: Loki
                    type: loki
                    access: proxy
                    url: http://loki-gateway
                ingress:
                  enabled: false
                  hosts:
                    - grafana.{{ environment }}.kais58.com

              alertmanager:
                enabled: true
